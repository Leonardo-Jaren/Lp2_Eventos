-- Base de datos LP2 Eventos - Versión refactorizada sin bucles
CREATE DATABASE lp2_eventos02;
USE lp2_eventos02;

-- 1. Tabla de roles
CREATE TABLE roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) UNIQUE NOT NULL
);

-- 2. Tabla de usuarios (tabla principal sin dependencias)
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombres VARCHAR(100) NOT NULL,
    apellidos VARCHAR(100) NOT NULL,
    correo VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    id_rol INT NOT NULL,
    FOREIGN KEY (id_rol) REFERENCES roles(id)
);

-- 3. Tabla de proveedores
CREATE TABLE proveedores (
id INT AUTO_INCREMENT PRIMARY KEY,
nombre VARCHAR(100) NOT NULL,
correo VARCHAR(100) UNIQUE NOT NULL,
empresa VARCHAR(100),
id_usuario INT,
FOREIGN KEY (id_usuario) REFERENCES usuarios(id)
);

-- 5. Tabla de servicios_proveedor
CREATE TABLE servicios_proveedor (
id INT AUTO_INCREMENT PRIMARY KEY,
id_proveedor INT,
nombre_servicio VARCHAR(100),
precio DECIMAL(10,2),
descripcion TEXT,
recursos JSON,
FOREIGN KEY (id_proveedor) REFERENCES proveedores(id)
);

-- 4. Tabla de reservas
CREATE TABLE reservas (
id INT AUTO_INCREMENT PRIMARY KEY,
id_evento INT,
fecha DATE NOT NULL,
hora_inicio TIME,
hora_fin TIME,
id_recurso INT,
estado ENUM('reservado', 'cancelado') DEFAULT 'reservado',
FOREIGN KEY (id_evento) REFERENCES eventos(id),
FOREIGN KEY (id_recurso) REFERENCES recursos(id)
);

-- 6. Tabla de contratos
CREATE TABLE contratos (
id INT AUTO_INCREMENT PRIMARY KEY,
id_proveedor INT,
fecha_inicio DATE NOT NULL,
fecha_fin DATE,
archivo_pdf VARCHAR(255),
estado ENUM('activo', 'finalizado') DEFAULT 'activo',
FOREIGN KEY (id_proveedor) REFERENCES proveedores(id)
);

-- 10. Inserción de roles base
INSERT INTO roles (nombre) VALUES
('Cliente'),
('Proveedor'),
('Organizador'),
('Administrador');

-- 11. Índices para optimizar consultas
CREATE INDEX idx_usuarios_correo ON usuarios(correo);
CREATE INDEX idx_usuarios_rol ON usuarios(id_rol);
CREATE INDEX idx_eventos_fecha ON eventos(fecha_evento);
CREATE INDEX idx_eventos_cliente ON eventos(id_cliente);
CREATE INDEX idx_servicios_proveedor ON servicios(id_proveedor);
CREATE INDEX idx_solicitudes_evento ON solicitudes_servicio(id_evento);
CREATE INDEX idx_solicitudes_servicio ON solicitudes_servicio(id_servicio);
CREATE INDEX idx_contratos_solicitud ON contratos(id_solicitud);